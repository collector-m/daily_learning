# LQR-==线性==二次型调节器[3. LQR公式到代码-Matlab与C语言设计_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1Ng4y1V7JQ/?p=3&spm_id_from=pageDriver&vd_source=3da170c3416f78cfe40e1a7ba3a4f5f9)

## 连续系统

目的：通过设计一个二次型的代价函数来描述控制系统的性能指标，并通过最小化该二次型代价函数来实现系统的优化调节。

- 二次型代价函数通常采用如下形式：

![ ](imgs/v2-1e88310c0e3f1a343d2e8da2e5039a6e_720w.webp)

其中，x(t) 表示系统状态变量，u(t) 表示控制输入，Q 和 R 是加权系数矩阵。

该代价函数可以看作是综合了系统状态变量和控制变量加权平方和的能量度量。通过不断改变代价函数的构造方式和权重矩阵，我们可以得到不同控制策略的结果。通过**调整 Q 和 R 的相对大小（比例）**，可以实现对系统不同方面的控制需求，例如想要提高系统的稳定性或者减少控制器对输入扰动的敏感度等等。

在轨迹跟踪中，前一项优化目标表示跟踪过程路径偏差的累积大小，第二项优化目标表示跟踪过程控制能量的损耗，这样就将轨迹跟踪控制问题转化为一个最优控制问题。

- 基本控制框图：

![img](imgs/v2-b66552bceae39efd28fc7d3693a61f54_r.jpg)

- 三大部分组成：
  - 系统模型：描述系统动态特性的数学模型，通常是由微分方程或差分方程表示的状态空间模型，包括系统状态矩阵 A、输入矩阵 B、输出矩阵 C 和直接耦合矩阵 D。
  - 控制器：利用状态反馈进行控制，将当前状态量通过增益矩阵 K 线性组合得到控制量，使系统稳定并能满足控制要求。
  - 观测器：使用系统模型的状态方程来推断系统当前状态的变化趋势，实现对系统状态量的估计。

- **小结：LQR 的代价函数和 QR 矩阵在计算最优的状态反馈增益矩阵时起重要作用，代价函数表示控制效果的好坏，QR 矩阵则体现了控制目标和能力的权衡关系。通过调整加权系数，可以实现对系统不同方面的控制需求。**

  

- **黎卡提方程求解增益矩阵K**

  - PID为**输出反馈**，即==以Y作为反馈== <img src="imgs/image-20240117122534294.png" alt="image-20240117122534294" style="zoom: 33%;" />

  - LQR为状态反馈，即==以x作为反馈==

    LQR算法中的增益矩阵K是一种常用的状态反馈控制。控制器可以表示为 u=-Kx，其中u是控制输入，x是状态向量，K是增益矩阵。如下图所示。

  <img src="imgs/image-20240117123343929.png" alt="image-20240117123343929" style="zoom:33%;" />

![ ](imgs/v2-c0bd80beec10e1b22ef886679c61a34a_720w.webp)

**黎卡提方程**：![ ](imgs/v2-8662e43b7600398e709c2ea2c0098534_720w.webp)

其中，A, B, Q, R是已知矩阵，**P是对称半正定矩阵，是黎卡提方程的解**。一旦解出黎卡提方程的对称半正定矩阵P，就可以使用其中的信息来计算LQR控制器的增益矩阵K。

![img](imgs/v2-acf926f2c4ccfa124af6f0a967e9b9b0_720w.png)

其中，R是一个对称正定矩阵，通常用于表示一个有限动态控制系统所施加的“代价”。在这个公式中，增益矩阵K 取决于已知的矩阵 P，B，R。
所以，可以把黎卡提方程简单理解为：求解状态反馈控制器增益矩阵K的一个数学工具。

可通过调用Matlab函数进行求解

```matlab
K=lqr(A,B,Q,R);
```



- 调参：QR矩阵如何影响控制效果

  - R相同，Q不同 

  在相同的R矩阵R=1下，左图的Q=[1 0;0 1]，右图的Q=[1 0;0 100]。

  因为Q矩阵的第二个元素变大，所以状态变量里的第二个变量x2也会收敛得更快，如下图所示

  <img src="imgs/v2-b9520145d1d70e80697097b598164e24_720w.webp" alt="在侧边栏查询中搜索" style="zoom: 67%;" />

  Q矩阵变大，x2状态变量收敛得更快，进而导致输出y收敛得更快，表现为响应速度更快，如下图所示：

  <img src="imgs/v2-116efbb7b64669926d4a35ba870d08c9_720w.webp" alt="在侧边栏查询中搜索" style="zoom: 67%;" />

  - R不同，Q相同 

    在相同的Q矩阵（[100,100])下，左图的R=1，右图的R=10。

    首先，对于K矩阵增益，R变大，对控制量大小的限制更大，所以增益矩阵应该是要变小的。

    因为R更大，所以控制输入u变小，会**收敛得更慢**，如下图所示。

    <img src="imgs/v2-941952eb1ca3b699ef0d2978b4ae2b3b_720w.webp" alt="img" style="zoom: 67%;" />

    因为R的变大导致控制输出u收敛得更慢，也就是蓝色曲线的控制输出更大，所以**响应会更慢**，如下图所示：

    <img src="imgs/v2-1b20f58b786c3052223e36501f5de155_720w.webp" alt="img" style="zoom:67%;" />

- 跟踪参考输入r(t)

<img src="imgs/image-20240117130344902.png" alt="image-20240117130344902" style="zoom:67%;" />

在r(t)与u(t)之间加入**积分环节**，消除存在的误差

<img src="imgs/image-20240117130545495.png" alt="image-20240117130545495" style="zoom:67%;" />





## 离散系统

对于一个离散时间系统：$\large X_{k+1}=AX_k+BU_k$；代价函数：$\large J=\sum_{k=1}^{N}\left(X^TQX+U^TRU\right)$

使用线性二次型调节器 ( Linear-Quadratic Regulator)，解出的最优控制规律u是关于状态变量X 的线性函数

![image-20240117142811926](imgs/image-20240117142811926.png)

![image-20240117142825206](imgs/image-20240117142825206.png)

- 求解步骤：

1. 确定迭代范围N，预设精度EPS

2. 设置迭代初始值$\large P=Q_f=Q$

3. 循环迭代：t=1 . . . . N

   ![image-20240117144315686](imgs/image-20240117144315686.png)

4. 计算反馈系数：

   ![image-20240117144420612](imgs/image-20240117144420612.png)

5. 最终得到优化控制量：![image-20240117144505020](imgs/image-20240117144505020.png)



# 车辆模型——[基于车辆==运动学==模型的LQR轨迹跟踪控制器 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/548227217)

- **基础模型**：以后轴中心为车辆中心的单车运动学模型

![img](imgs/v2-0c1f016a455430e64ebd3882e362a279_720w.webp)

![image-20240117151324165](imgs/image-20240117151324165.png)

这是一个**非线性模型**。基于非线性模型的优化计算难度非常大，常将其线性化，转化成线性模型。LQR控制方法既适用于连续模型，也适用于离散模型，本文采用离散模型。离散化和线性化的先后顺序对最后得到的模型并无影响，先离散化后线性化以及先线性化再离散化得到的模型是一样的。



- **模型线性化**

<img src="imgs/image-20240117152526232.png" alt="image-20240117152526232" style="zoom:;" />

- **模型离散化**

![image-20240117153009763](imgs/image-20240117153009763.png)

- **代码实现**

完整代码：见[【自动驾驶】LQR控制实现轨迹跟踪 | python实现 | c++实现_lqr轨迹跟踪-CSDN博客](https://blog.csdn.net/weixin_42301220/article/details/125031348?ops_request_misc=&request_id=&biz_id=102&utm_term=lqr控制&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-3-125031348.nonecase&spm=1018.2226.3001.4187)

结果如下：

![lqr](imgs/lqr.png)

- 总结
  - 优点：只要形式合适，满足系统的条件就可以直接构造LQR，求解也非常直观。在调节参数的过程中也是非常直观的，根据系统具体的性能要求设计相应的LQR控制器，调节相应的参数
  - 缺点： 由于它是线性优化调节器，在大转向角的情况下，模型会出现偏差，线性化偏差更大。只考虑了当前点的误差，并没有考虑未来的路径的情况，所以比较短视