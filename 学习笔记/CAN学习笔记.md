# 底盘通信CAN总线协议

## 概述

控制器局域网CAN（controller area network）属于现场总线的范畴，是一种有效支持分布式控制系统的串行通信网络，用于汽车中各种不同元件之间的通信。

CAN通讯速率与CAN总线长度的关系大致如下图：·

![img](https://camo.githubusercontent.com/421de993f10c3a9de0fc166cbf5d7a4ff5c53f83c29ff3b518f3b0c3ae74737f/68747470733a2f2f706963332e7a68696d672e636f6d2f38302f76322d35613037303737653131323735363836626663646564303164373935623437615f373230772e6a7067)



### CAN总线信号

![img](https://camo.githubusercontent.com/4dec07194f49b793fe3fc7f6f986d6c8b9650abe66cdfab00f2806da8b275b57/68747470733a2f2f706963342e7a68696d672e636f6d2f38302f76322d35323738303237343035356462326339326439653766383834346330666330335f373230772e6a7067)

在CAN总线上，信号表现为电压形式，通过CAN_H与CAN_L线上的电位差来表示CAN信号的显性电平和隐性电平。 显性电平规定为逻辑0，隐性电平规定为逻辑1，具体可以通过上图看出。 其实CAN总线的规定为，电压差满足一定的范围，就可以认为是显性电平或者隐性电平。



### CAN信号传输过程

1.在发送过程，CAN控制器将CPU传来的信号转换为逻辑电平。CAN收发器接收逻辑电平之后，再将其转换为差分电平输出到CAN总线上。

2.在接收过程，CAN收发器将CAN_H 和 CAN_L 线上传来的差分电平转换为逻辑电平输出到CAN控制器，CAN控制器再把该逻辑电平转化为相应的信号发送到CPU上。



## 协议帧结构

共有下面五种类型：

![img](https://camo.githubusercontent.com/2f608d16b4b0c854fe50ce7f337bfba9c4d8dccccaa138cc159b2cb92b039eee/68747470733a2f2f706963342e7a68696d672e636f6d2f38302f76322d62363437353664353039646263336137666133303362383634353937343830665f373230772e6a7067)

==**数据帧**==：帧起始、仲裁段、控制段、数据段、校验码域、应答域、帧结束

![68747470733a2f2f706963342e7a68696d672e636f6d2f38302f76322d36646434663633613637343731363135396131383432306530646264376237665f373230772e6a7067 (720×491)](https://camo.githubusercontent.com/8f3b554fd379cd5d37cfbcf18580cbcc11b3dd65b6a21c3a540faa16ed93db2d/68747470733a2f2f706963342e7a68696d672e636f6d2f38302f76322d36646434663633613637343731363135396131383432306530646264376237665f373230772e6a7067)

### 帧起始，帧结束

![68747470733a2f2f696d61676573302e636e626c6f67732e636f6d2f626c6f672f3637313031392f3230313430392f3232313933393035353736383733362e706e67 (923×558)](https://camo.githubusercontent.com/62366f872771e8dddbf535f71d359c68b344882364164721d90c5f1a6786b108/68747470733a2f2f696d61676573302e636e626c6f67732e636f6d2f626c6f672f3637313031392f3230313430392f3232313933393035353736383733362e706e67)



### 仲裁段

规定了数据的优先级

CAN总线在发送数据时同时监测数据线的电平是否与发送数据对应电平相同， 如果不同，则停止发送并做其他处理。 表示数据的优先级的段，起作用就是根据报文ID来确定其发送优先级。标准格式和扩展格式在此的构成有所不同。 **帧ID值越小，优先级越高**（仲裁帧实质上是帧的id）



### 数据段

-  **编码格式**：Motorola格式和Intel格式
  -  **Motorola格式**类似于大端模式，即**高字节存低地址，低字节存高地址**
  - **Intel格式**类似于小端模式，即**高字节存高地址，低字节存低地址**

- LSB：最低有效位，为一个二进制数字中的第0位（即最低位）


- MSB：最高有效位，为一个n位二进制数字中的第n-1位（即最高位）


以一个十六进制数：0x12345678为例，从高字节到低字节依次为12、34、56、78；

- Motorola格式（大端模式）：

低地址— Byte0        Byte1          Byte2          Byte3 —高地址

​                  12              34                 56                78

- Intel格式（小端模式）：

低地址— Byte0        Byte1           Byte2         Byte3 —高地址

​                  78               56                34                12

现在底盘中的通讯协议矩阵-CANA中报文的排列格式均为**Motorola Foward LSB格式**，即以低位**LSB为起始位**，高字节在前，低字节在后，每个字节内从bit0往bit7排，往低字节借位，例子如下：

![img](https://img-blog.csdnimg.cn/dd477e2cc5aa4feba028e15ec080536d.png)

![img](https://img-blog.csdnimg.cn/dc5391e393c744adae2c199a852edde5.png)

## 编译总结

编译过程中发现除了起始字节，起始位，信号长度外，**报文标识符、精度和偏移量**也需要在代码编译中进行细节处理：

- 报文标识符为ID
- 精度/偏移量：用来描述信号值如何转变成真实物理值/真实物理值转变成信号值
- **物理值公式**：
  - 真实物理值 = 信号值 × 精度 + 偏移量，与PIX底盘中的**Report报文**相对应，即从信号值—>真实值
  - 信号值 =（真实物理值—偏移量）/ 精度，与PIX底盘中的**Command报文**相对应，即从真实值—>信号值
